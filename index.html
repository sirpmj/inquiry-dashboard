<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inquiry Pool Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;}body{margin:0;font-family:'Poppins',sans-serif;background:#f4f6f9;color:#333;}
header{background:linear-gradient(135deg,#1f2937,#111827);color:#fff;padding:16px;text-align:center;font-size:20px;font-weight:600;display:flex;justify-content:space-between;align-items:center;}
header span{font-size:16px;cursor:pointer;background:#6366f1;padding:6px 10px;border-radius:6px;}
.container{max-width:1200px;margin:auto;padding:12px;}
.card{background:#fff;border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 4px 14px rgba(0,0,0,.06);}
h3{margin:0 0 8px 0;font-size:16px;}
label{display:block;font-weight:500;margin-top:6px;}
input,select,button{width:100%;padding:10px 12px;margin:4px 0;border-radius:8px;border:1px solid #dcdcdc;font-size:14px;font-family:'Poppins';}
input:focus,select:focus{outline:none;border-color:#6366f1;}
button{background:#6366f1;color:#fff;border:none;font-weight:500;cursor:pointer;transition:.2s;}
button:hover{opacity:.9;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;}
.qtyBox{display:flex;gap:10px;overflow:auto;margin-bottom:6px;}
.qtyItem{min-width:120px;background:#eef2ff;border:1px solid #c7d2fe;padding:8px 12px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;white-space:nowrap;text-align:center;}
.qtyItem:hover{background:#dbeafe;border-color:#6366f1;}
table{width:100%;border-collapse:collapse;font-size:13px;}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;}
th{
  background:#111827;
  color:#fff;
  position:sticky;
  top:0;
  cursor:pointer;
  white-space:nowrap;
}

.status-Open{background:#fff7d6;}
.status-Matched{background:#dbfce7;}
.status-Closed{background:#ffe1e1;}
.actionIcons span{cursor:pointer;margin-right:6px;font-size:16px;}
.tableWrap{overflow:auto;max-height:420px;}
@media(max-width:600px){header{font-size:18px;}}
.checkbox{width:16px;height:16px;cursor:pointer;}
#charts{display:flex;gap:12px;flex-wrap:wrap;}
.chartCard{flex:1;min-width:220px;padding:10px;background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1);}

.tableTopBar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:8px;
}
.tableTopBar button{
  width:auto;
  padding:8px 14px;
  font-size:13px;
}


.filterBar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}
.filterBar input,
.filterBar select{
  width:auto;
  min-width:180px;
  padding:8px 12px;
  font-size:13px;
}



</style>
</head>

<body>

<div id="followupModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);align-items:center;justify-content:center;z-index:9999;">
  <div style="background:#fff;width:320px;padding:16px;border-radius:10px;">
    <h3 style="margin-top:0">Add Follow-up</h3>
    <input type="date" id="fuDate" style="width:100%;margin-bottom:8px;">
    <textarea id="fuNote" placeholder="Note" style="width:100%;height:60px;"></textarea>
    <div style="display:flex;gap:8px;margin-top:10px;">
      <button onclick="saveFollowup()">Save</button>
      <button onclick="closeFollowup()" style="background:#e5e7eb;color:#111;">Cancel</button>
    </div>
  </div>
</div>

<header>
  üì¶ Inquiry Pool Dashboard
  <span onclick="logout()">Logout</span>
</header>

<div class="container">

  <!-- Login / Signup -->
  <div class="card" id="loginBox">
  <h3 id="formTitle">Login</h3>

  <input id="name" type="text" placeholder="Full Name" style="display:none;">
<input id="signupMobile" type="text" placeholder="Mobile Number" style="display:none;">
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">

  <button id="mainBtn" onclick="login()">Login</button>
  <button onclick="showSignup()" id="toggleBtn" style="background:#e5e7eb;color:#111;">
    Create Account
  </button>
</div>


  <!-- Dashboard -->
  <div id="dashboard" style="display:none">

    <div class="card" id="userBox">
      Logged in as: <b id="userName"></b> (<span id="userRole"></span>)
      <span onclick="logout()" style="cursor:pointer;color:#6366f1;margin-left:10px;">Logout</span>
    </div>

    <div class="card" id="totalsCard">
      <h3>üìä Product Totals</h3>
      <div id="totals" class="qtyBox"></div>
      <div id="statusTotals"></div>
    </div>

   


    <div class="card" id="inquiryCard">
      <h3>Add / Update Inquiry</h3>
      <div class="grid">
        <div>
          <label>Product</label>
          <input id="product" placeholder="Product Name">
        </div>
        <div>
          <label>Sale / Purchase</label>
          <select id="salePurchase">
            <option>Sale</option>
            <option>Purchase</option>
          </select>
        </div>
        <div>
          <label>Qty</label>
          <input id="qty" type="number" placeholder="Quantity">
        </div>
        <div>
          <label>Party</label>
          <input id="party" placeholder="Party Name">
        </div>
<div>
  <label>Mobile No</label>
  <input id="partyMobile" placeholder="Mobile Number">

</div>

        <div>
          <label>Rate</label>
          <input id="rate" placeholder="Rate">
        </div>
        <div>
          <label>Available With</label>
          <input id="availableWith" placeholder="Available With">
        </div>
<div>
  <label>Allot To Salesman</label>
  <select id="assignSalesman"></select>
</div>

        <div>
          <label>Remark</label>
          <input id="remark" placeholder="Remark">
        </div>
      </div>
      <button onclick="addInquiry()">Save Inquiry</button>
    </div>

<div class="filterBar">
  <input id="search" placeholder="üîç Search Product">
  <select id="categoryFilter">
    <option value="">All Category</option>
    <option>Sale</option>
    <option>Purchase</option>
  </select>
  <select id="salesmanFilter"></select>
</div>

   <div class="card" id="tableCard">
      <h3>üìã Live Inquiry Table</h3>
      <div class="tableTopBar">
  <button onclick="bulkClose()">Selected Closed</button>
  <button onclick="bulkDelete()">Selected Delete</button>
  <button onclick="exportCSV()">Export CSV</button>
</div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAll" class="checkbox" onclick="toggleSelectAll(this)"></th>
              <th onclick="sortTable('date')">Date</th>
              <th onclick="sortTable('product')">Product</th>
              <th>Sale / Purchase</th>
              <th onclick="sortTable('qty')">Qty</th>
              <th>Party</th>
<th>Mobile</th>
              <th>Available</th>
              <th>Salesman</th>
              <th>Status / Action</th>
            </tr>
          </thead>
          <tbody id="data"></tbody>
        </table>
      </div>
    </div>

    <div id="charts" class="card">
      <div class="chartCard"><canvas id="chartSalePurchase"></canvas></div>
      <div class="chartCard"><canvas id="chartStatus"></canvas></div>
    </div>

  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// üîπ Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyCuPj2Zayn-b-USaCoC3d_eA0FALPrBqXg",
    authDomain: "inquiry-pool-dashboard.firebaseapp.com",
    projectId: "inquiry-pool-dashboard",
    storageBucket: "inquiry-pool-dashboard.appspot.com",
    messagingSenderId: "722727372065",
    appId: "1:722727372065:web:03302e83335325885dea60"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

auth.onAuthStateChanged(async (user) => {
  if (user) {
    currentUser = user;
    loadUserRole();   // direct dashboard
  } else {
    document.getElementById("loginBox").style.display="block";
    document.getElementById("dashboard").style.display="none";
  }
});


function showMsg(msg, ok=true){
  const d = document.createElement("div");
  d.innerText = msg;
  d.style.position="fixed";
  d.style.top="20px";
  d.style.right="20px";
  d.style.padding="10px 14px";
  d.style.background= ok ? "#16a34a" : "#dc2626";
  d.style.color="#fff";
  d.style.borderRadius="8px";
  d.style.zIndex="9999";
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),3000);
}

let fuParty="", fuMobile="";

function addFollowup(party, mobile){
  fuParty = party;
  fuMobile = mobile;
  document.getElementById("followupModal").style.display="flex";
}

function closeFollowup(){
  document.getElementById("followupModal").style.display="none";
}

function saveFollowup(){
  const date = document.getElementById("fuDate").value;
  const note = document.getElementById("fuNote").value;

  if(!date){ alert("Select date"); return; }

  db.collection('followups').add({
    party: fuParty,
    mobile: fuMobile,
    date,
    note,
    createdBy: currentUser.uid,
    createdAt: new Date()
  });

  closeFollowup();
}

// ==== Globals ====
let currentUser = null;
let editId = null;
let userRole = null; // 'admin' or 'salesman'
let usersMap = {};


// ==== Login/Signup ====
async function login(){
  try{
    const email = document.getElementById("email").value.trim();
    const pass = document.getElementById("password").value.trim();
const mobile = document.getElementById("signupMobile").value.trim();

    const res = await auth.signInWithEmailAndPassword(email, pass);
    currentUser = res.user;

    const doc = await db.collection('users').doc(currentUser.uid).get();

    applyUserProfile(doc.data());

  }catch(e){
    showMsg(e.message,false);
  }
}

async function signup(){
  try{
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    const pass = document.getElementById("password").value.trim();

    if(!name){ showMsg("Enter name", false); return; }

    const res = await auth.createUserWithEmailAndPassword(email, pass);

    await res.user.updateProfile({ displayName: name });

   await db.collection('users').doc(res.user.uid).set({
  name: name,
  email: email,
  mobile: mobile,
  role: "salesman"
});


    // üî¥ IMPORTANT ‚Äî logout after signup
    await auth.signOut();

    // ‚úÖ clear fields
    document.getElementById("name").value="";
    document.getElementById("email").value="";
    document.getElementById("password").value="";

    // ‚úÖ back to login screen
    showLogin();

  }catch(e){
    showMsg(e.message,false);
  }
}

function logout(){ 
  auth.signOut().then(()=>location.reload()); 
}

let isSignup = false;

function showSignup(){
  isSignup = true;
  document.getElementById("name").style.display = "block";
document.getElementById("mobile").style.display = "block";
  document.getElementById("formTitle").innerText = "Sign Up";
  document.getElementById("mainBtn").innerText = "Sign Up";
  document.getElementById("mainBtn").onclick = signup;
  document.getElementById("toggleBtn").innerText = "Back to Login";
  document.getElementById("toggleBtn").onclick = showLogin;
}

function showLogin(){
  isSignup = false;
  document.getElementById("name").style.display = "none";
document.getElementById("mobile").style.display = "none";
  document.getElementById("formTitle").innerText = "Login";
  document.getElementById("mainBtn").innerText = "Login";
  document.getElementById("mainBtn").onclick = login;
  document.getElementById("toggleBtn").innerText = "Create Account";
  document.getElementById("toggleBtn").onclick = showSignup;
}


// ==== Load Dashboard ====
function loadUserRole(){
  const uid = currentUser.uid;

  db.collection('users').doc(uid).get().then(doc=>{
    if(!doc.exists){
      // üëá AUTO CREATE USER PROFILE
      const profile = {
        name: currentUser.displayName || currentUser.email,
        email: currentUser.email,
        role: "admin" // üëà first time admin (ya salesman)
      };

      db.collection('users').doc(uid).set(profile).then(()=>{
        applyUserProfile(profile);
      });

    } else {
      applyUserProfile(doc.data());
    }
  });
}

function applyUserProfile(data){
  userRole = data.role || "salesman";

  document.getElementById("userName").innerText =
    data.name || currentUser.email;

  document.getElementById("userRole").innerText = userRole;

  document.getElementById("loginBox").style.display="none";
  document.getElementById("dashboard").style.display="block";

updateFilters().then(()=>{
  setupRealtime();
});
}


// ==== Realtime Listener ====
function setupRealtime(){
  db.collection('inquiries').orderBy('date','desc').onSnapshot(snap=>{
    window.inquiries = [];
    snap.forEach(doc=>{
      const i = doc.data(); i.id=doc.id;
      window.inquiries.push(i);
    });
    renderTable();
    renderCharts();
  });
}

// ==== Filters ====
document.getElementById("search").addEventListener("input", renderTable);
document.getElementById("categoryFilter").addEventListener("change", renderTable);
document.getElementById("salesmanFilter").addEventListener("change", renderTable);

async function updateFilters(){
  const snap = await db.collection('users').get();

  const select = document.getElementById("salesmanFilter");
  const assign = document.getElementById("assignSalesman");

  select.innerHTML = "<option value=''>All Salesmen</option>";
  assign.innerHTML = "";

  usersMap = {};

  snap.forEach(doc=>{
    const data = doc.data();

    usersMap[doc.id] = {
      name: data.name,
      mobile: data.mobile || ""
    };

    select.innerHTML += `<option value="${doc.id}">${data.name}</option>`;
    assign.innerHTML += `<option value="${doc.id}">${data.name}</option>`;
  });
}



// ==== Add / Update Inquiry ====
function addInquiry(){
  const p=document.getElementById("product").value.trim();
  const qty=Number(document.getElementById("qty").value);
  if(!p||!qty){alert("Product & Qty required"); return;}
  const obj={
    product:p,
    salePurchase:document.getElementById("salePurchase").value,
    qty:qty,
    party:document.getElementById("party").value,
mobile:document.getElementById("partyMobile").value,

    rate:document.getElementById("rate").value,
    availableWith:document.getElementById("availableWith").value,
    remark:document.getElementById("remark").value,
    salesmanId: document.getElementById("assignSalesman").value,

    status:"Open",
    date:new Date()
  };
  if(editId){
    db.collection('inquiries').doc(editId).set(obj);
    editId=null;
  }else{
    db.collection('inquiries').add(obj);
  }
  clearInquiryForm();
}

// ==== Table Rendering ====
let sortField=null, sortAsc=true;
function sortTable(field){
  if(sortField===field) sortAsc=!sortAsc; else {sortField=field; sortAsc=true;}
  renderTable();
}
function renderTable(){
  const tbody=document.getElementById("data");
  tbody.innerHTML="";
  const searchVal=document.getElementById("search").value.toLowerCase();
  const catVal=document.getElementById("categoryFilter").value;
  const salesVal=document.getElementById("salesmanFilter").value;

  let filtered = window.inquiries.filter(i=>{
    if(searchVal && !i.product.toLowerCase().includes(searchVal)) return false;
    if(catVal && i.salePurchase!==catVal) return false;
    if(salesVal && i.salesmanId!==salesVal) return false;
    return true;
  });

  if(sortField){
    filtered.sort((a,b)=>{
      let va = a[sortField], vb=b[sortField];
      if(sortField==="date"){ va=new Date(va); vb=new Date(vb);}
      if(va<vb) return sortAsc?-1:1;
      if(va>vb) return sortAsc?1:-1;
      return 0;
    });
  }

  filtered.forEach(i=>{
    const canEdit = (userRole==='admin'||i.salesmanId===currentUser.uid);
    tbody.innerHTML+=`
      <tr class="status-${i.status}">
        <td><input type="checkbox" class="rowCheckbox checkbox"></td>
        <td>${formatDate(i.date)}</td>
        <td>${i.product}</td>
        <td>${i.salePurchase}</td>
        <td>${i.qty}</td>
        <td>${i.party}</td>

<td>
  ${i.mobile || ''}
  ${i.mobile ? `
    <div style="display:flex;gap:6px;margin-top:4px;font-size:16px;">
      <span onclick="callParty('${i.mobile}')" title="Call">üìû</span>
      <span onclick="sendWhatsApp('${i.id}')" style="cursor:pointer">üü¢</span>
      <span onclick="showPartyHistory('${i.party}')" title="History">üìú</span>
      <span onclick="addFollowup('${i.party}','${i.mobile}')" title="Follow Up">‚è∞</span>
    </div>
  ` : ``}
</td>

        <td>${i.availableWith}</td>
        <td>${getSalesmanName(i.salesmanId)}</td>
        <td class="actionIcons">
          ${canEdit?`<span onclick="editInquiry('${i.id}')">‚úèÔ∏è</span><span onclick="deleteRow('${i.id}')">üóëÔ∏è</span>`:""}
          <span onclick="toggleStatus('${i.id}')">üîÑ</span>
        </td>
      </tr>
    `;
  });

  renderTotals();
}

// ==== Helper ====
function getSalesmanName(uid){
  return usersMap[uid] || "Unknown";
}


function clearInquiryForm(){
 ["product","qty","party","partyMobile","rate","availableWith","remark"]

 .forEach(id=>document.getElementById(id).value="");
}

function formatDate(d){
  const dt = new Date(d.seconds ? d.seconds*1000 : d);
  const dd = String(dt.getDate()).padStart(2,'0');
  const mm = String(dt.getMonth()+1).padStart(2,'0');
  const yyyy = dt.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
}


// ==== Edit/Delete/Toggle ====
function editInquiry(id){
  editId=id;
  const i = window.inquiries.find(x=>x.id===id);
  document.getElementById("product").value=i.product;
  document.getElementById("salePurchase").value=i.salePurchase;
  document.getElementById("qty").value=i.qty;
  document.getElementById("party").value=i.party;
document.getElementById("partyMobile").value=i.mobile || '';

  document.getElementById("rate").value=i.rate;
  document.getElementById("availableWith").value=i.availableWith;
document.getElementById("assignSalesman").value = i.salesmanId;
  document.getElementById("remark").value=i.remark;
}
function deleteRow(id){ if(confirm("Delete?")) db.collection('inquiries').doc(id).delete(); }
function toggleStatus(id){
  const i = window.inquiries.find(x=>x.id===id);
  let s=i.status==="Open"?"Matched":i.status==="Matched"?"Closed":"Open";
  db.collection('inquiries').doc(id).update({status:s});
}

// ==== Bulk Actions ====
function toggleSelectAll(el){
  document.querySelectorAll(".rowCheckbox").forEach(cb=>cb.checked=el.checked);
}
function bulkClose(){
  document.querySelectorAll(".rowCheckbox").forEach((cb,i)=>{
    if(cb.checked){
      const id = window.inquiries[i].id;
      db.collection('inquiries').doc(id).update({status:'Closed'});
    }
  });
}
function bulkDelete(){
  document.querySelectorAll(".rowCheckbox").forEach((cb,i)=>{
    if(cb.checked){
      const id=window.inquiries[i].id;
      db.collection('inquiries').doc(id).delete();
    }
  });
}

// ==== Totals & Charts ====
function renderTotals(){
  const totalsDiv=document.getElementById("totals");
  totalsDiv.innerHTML="";
  let totals={}, pending=0, closed=0;
  window.inquiries.forEach(i=>{
    totals[i.product]=(totals[i.product]||0)+i.qty;
    if(i.status==="Open") pending+=i.qty;
    if(i.status==="Closed") closed+=i.qty;
  });
  for(let p in totals) totalsDiv.innerHTML+=`<div class="qtyItem">${p}: <b>${totals[p]}</b></div>`;
  document.getElementById("statusTotals").innerHTML=`<b>Open Qty:</b> ${pending} | <b>Closed Qty:</b> ${closed}`;
}

let chartSP=null, chartStatus=null;

function renderCharts(){
  const spLabels=[], spData=[];
  const statusLabels=['Open','Matched','Closed'];
  const statusData=[0,0,0];
  const spMap={};

  window.inquiries.forEach(i=>{
    spMap[i.salePurchase]=(spMap[i.salePurchase]||0)+i.qty;

    if(i.status==="Open") statusData[0]+=i.qty;
    if(i.status==="Matched") statusData[1]+=i.qty;
    if(i.status==="Closed") statusData[2]+=i.qty;
  });

  for(let k in spMap){
    spLabels.push(k);
    spData.push(spMap[k]);
  }

  if(chartSP) chartSP.destroy();
  chartSP = new Chart(document.getElementById("chartSalePurchase"),{
    type:'bar',
    data:{
      labels:spLabels,
      datasets:[{
        label:'Total Qty',
        data:spData,
        backgroundColor:'#6366f1'
      }]
    },
    options:{responsive:true}
  });

  if(chartStatus) chartStatus.destroy();
  chartStatus = new Chart(document.getElementById("chartStatus"),{
    type:'pie',
    data:{
      labels:statusLabels,
      datasets:[{
        data:statusData,
        backgroundColor:['#fde68a','#86efac','#fca5a5']
      }]
    },
    options:{responsive:true}
  });
}

function callParty(mobile){
  window.open(`tel:${mobile}`);
}

function whatsappParty(mobile, party, product){
  const msg = `Hello ${party}, regarding ${product} inquiry.`;
  window.open(`https://wa.me/91${mobile}?text=${encodeURIComponent(msg)}`);
}

function showPartyHistory(party){
  const rows = window.inquiries.filter(i=>i.party===party);
  let text = `History for ${party}:\n\n`;
  rows.forEach(r=>{
    text += `${r.product} | Qty:${r.qty} | ${r.salePurchase} | ${r.status}\n`;
  });
  alert(text);
}

function sendWhatsApp(id){
  const i = window.inquiries.find(x=>x.id===id);

  const partyMobile = i.mobile || "";
  const salesman = usersMap[i.salesmanId];
  const salesmanMobile = salesman?.mobile || "";

  // ‚úÖ Party Message
  const partyMsg = `Hello ${i.party},

We have inquiry for:
Product: ${i.product}
Qty: ${i.qty}

We will contact you shortly.`;

  // ‚úÖ Salesman Message
  const salesmanMsg = `New Inquiry Assigned

Party: ${i.party}
Mobile: ${i.mobile}
Product: ${i.product}
Qty: ${i.qty}
Status: ${i.status}`;

  // Party WhatsApp
  if(partyMobile){
    window.open(`https://wa.me/91${partyMobile}?text=${encodeURIComponent(partyMsg)}`);
  }

  // Salesman WhatsApp (delay)
  if(salesmanMobile){
    setTimeout(()=>{
      window.open(`https://wa.me/91${salesmanMobile}?text=${encodeURIComponent(salesmanMsg)}`);
    },800);
  }
}



</script>
