<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inquiry Pool Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
* {box-sizing:border-box;}
body {margin:0; font-family:'Poppins',sans-serif; background:#f4f6f9; color:#333;}
header {background:linear-gradient(135deg,#1f2937,#111827); color:#fff; padding:16px; display:flex; justify-content:space-between; align-items:center; font-size:20px;}
header span {font-size:16px; cursor:pointer; background:#6366f1; padding:6px 10px; border-radius:6px;}
.container {max-width:1200px; margin:auto; padding:12px;}
.card {background:#fff; border-radius:12px; padding:14px; margin-bottom:14px; box-shadow:0 4px 14px rgba(0,0,0,.06);}
h3 {margin:0 0 8px 0; font-size:16px;}
label {display:block; font-weight:500; margin-top:6px;}
input, select, button {width:100%; padding:10px 12px; margin:4px 0; border-radius:8px; border:1px solid #dcdcdc; font-size:14px;}
input:focus, select:focus {outline:none; border-color:#6366f1;}
button {background:#6366f1; color:#fff; border:none; font-weight:500; cursor:pointer; transition:.2s;}
button:hover {opacity:.9;}
.grid {display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px;}
.qtyBox {display:flex; gap:10px; overflow:auto; margin-bottom:6px;}
.qtyItem {min-width:120px; background:#eef2ff; border:1px solid #c7d2fe; padding:8px 12px; border-radius:8px; font-size:13px; font-weight:500; cursor:pointer; white-space:nowrap; text-align:center;}
.qtyItem:hover {background:#dbeafe; border-color:#6366f1;}
table {width:100%; border-collapse:collapse; font-size:13px;}
th, td {padding:8px; border-bottom:1px solid #eee; text-align:left;}
th {background:#111827; color:#fff; position:sticky; top:0; cursor:pointer;}
.status-Open {background:#fff7d6;}
.status-Matched {background:#dbfce7;}
.status-Closed {background:#ffe1e1;}
.actionIcons span {cursor:pointer; margin-right:6px; font-size:16px;}
.tableWrap {overflow:auto; max-height:420px;}
@media(max-width:600px){header{font-size:18px;}}
.checkbox {width:16px; height:16px; cursor:pointer;}
</style>
</head>
<body>

<header>
  üì¶ Inquiry Pool Dashboard
  <span onclick="logout()">Logout</span>
</header>

<div class="container">

  <!-- Login / Signup -->
  <div class="card" id="loginBox">
    <h3>Salesman Login / Signup</h3>
    <input id="email" type="email" placeholder="Enter your email">
    <input id="password" type="password" placeholder="Enter password">
    <button onclick="login()">Login</button>
    <button onclick="signup()">Sign Up</button>
  </div>

  <div class="card" id="userBox" style="display:none">
    Logged in as: <b id="userName"></b>
    <span onclick="logout()" style="cursor:pointer;color:#6366f1;margin-left:10px;">Logout</span>
  </div>

  <!-- Totals -->
  <div class="card" id="totalsCard" style="display:none">
    <h3>üìä Product Totals</h3>
    <div id="totals" class="qtyBox"></div>
    <div id="statusTotals"></div>
  </div>

  <!-- Filters -->
  <div class="card" id="filterCard" style="display:none">
    <h3>üîç Filters</h3>
    <input id="search" placeholder="Search Product">
    <select id="categoryFilter">
      <option value="">All Category</option>
      <option>Sale</option>
      <option>Purchase</option>
    </select>
    <select id="salesmanFilter">
      <option value="">All Salesmen</option>
    </select>
  </div>

  <!-- Add Inquiry -->
  <div class="card" id="inquiryCard" style="display:none">
    <h3>Add / Update Inquiry</h3>
    <div class="grid">
      <div><label>Product</label><input id="product" placeholder="Product Name"></div>
      <div><label>Sale / Purchase</label><select id="salePurchase"><option>Sale</option><option>Purchase</option></select></div>
      <div><label>Qty</label><input id="qty" type="number" placeholder="Quantity"></div>
      <div><label>Party</label><input id="party" placeholder="Party Name"></div>
      <div><label>Rate</label><input id="rate" placeholder="Rate"></div>
      <div><label>Available With</label><input id="availableWith" placeholder="Available With"></div>
      <div><label>Remark</label><input id="remark" placeholder="Remark"></div>
    </div>
    <button onclick="addInquiry()">Save Inquiry</button>
  </div>

  <!-- Table -->
  <div class="card" id="tableCard" style="display:none">
    <h3>üìã Live Inquiry Table</h3>
    <div>
      <button onclick="bulkClose()">Mark Selected Closed</button>
      <button onclick="bulkDelete()">Delete Selected</button>
    </div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll" class="checkbox" onclick="toggleSelectAll(this)"></th>
            <th onclick="sortTable('date')">Date</th>
            <th onclick="sortTable('product')">Product</th>
            <th>Sale / Purchase</th>
            <th onclick="sortTable('qty')">Qty</th>
            <th>Party</th>
            <th>Available</th>
            <th>Salesman</th>
            <th>Status / Action</th>
          </tr>
        </thead>
        <tbody id="data"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyCuPj2Zayn-b-USaCoC3d_eA0FALPrBqXg",
    authDomain: "inquiry-pool-dashboard.firebaseapp.com",
    projectId: "inquiry-pool-dashboard",
    storageBucket: "inquiry-pool-dashboard.appspot.com",
    messagingSenderId: "722727372065",
    appId: "1:722727372065:web:03302e83335325885dea60"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Global
let inquiries = [];
let editIndex = null;

// ===== LOGIN / SIGNUP =====
function signup() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const name = prompt("Enter your name for signup:");

  if(!email || !password || !name) { alert("All fields required"); return; }

  auth.createUserWithEmailAndPassword(email, password)
    .then(userCredential => {
      const uid = userCredential.user.uid;
      return db.collection("users").doc(uid).set({ name });
    })
    .then(() => showDashboardFirebase())
    .catch(err => alert(err.message));
}

function login() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  if(!email || !password) { alert("Email & password required"); return; }

  auth.signInWithEmailAndPassword(email, password)
    .then(() => showDashboardFirebase())
    .catch(err => alert(err.message));
}

function showDashboardFirebase() {
  const user = auth.currentUser;
  if(!user) return;

  document.getElementById("loginBox").style.display="none";
  document.getElementById("userBox").style.display="block";
  document.getElementById("totalsCard").style.display="block";
  document.getElementById("filterCard").style.display="block";
  document.getElementById("inquiryCard").style.display="block";
  document.getElementById("tableCard").style.display="block";

  db.collection("users").doc(user.uid).get().then(doc=>{
    document.getElementById("userName").innerText = doc.data().name;
  });

  loadInquiries();
}

// ===== LOAD INQUIRIES =====
function loadInquiries() {
  const user = auth.currentUser;
  if(!user) return;

  db.collection("inquiries").where("salesmanId","==",user.uid).get()
    .then(snapshot => {
      inquiries = [];
      snapshot.forEach(doc => inquiries.push(doc.data()));
      renderTable();
    });
}

// ===== ADD INQUIRY =====
function addInquiry() {
  const user = auth.currentUser;
  if(!user) return alert("Not logged in");

  const p = document.getElementById("product").value.trim();
  const qtyVal = Number(document.getElementById("qty").value);
  if(!p || !qtyVal) { alert("Product & Qty required"); return; }

  const obj = {
    product: p,
    salePurchase: document.getElementById("salePurchase").value,
    qty: qtyVal,
    party: document.getElementById("party").value,
    rate: document.getElementById("rate").value,
    availableWith: document.getElementById("availableWith").value,
    remark: document.getElementById("remark").value,
    salesmanId: user.uid,
    status: "Open",
    date: new Date().toLocaleDateString()
  };

  db.collection("inquiries").add(obj)
    .then(() => {
      inquiries.push(obj);
      clearInquiryForm();
      renderTable();
    })
    .catch(err => alert(err.message));
}

function clearInquiryForm(){
  ["product","qty","party","rate","availableWith","remark"].forEach(id=>document.getElementById(id).value="");
}

// ===== LOGOUT =====
function logout() {
  auth.signOut().then(()=>location.reload());
}

// ===== TABLE / FILTERS / CRUD =====
let sortField=null, sortAsc=true;
function sortTable(field){ if(sortField===field) sortAsc=!sortAsc; else {sortField=field; sortAsc=true;} renderTable(); }
function toggleSelectAll(el){ document.querySelectorAll(".rowCheckbox").forEach(cb=>cb.checked=el.checked); }
function bulkClose(){ document.querySelectorAll(".rowCheckbox").forEach((cb,i)=>{ if(cb.checked) inquiries[i].status="Closed"; }); renderTable(); }
function bulkDelete(){ for(let i=inquiries.length-1;i>=0;i--){ if(document.querySelectorAll(".rowCheckbox")[i].checked){ inquiries.splice(i,1); } } renderTable(); }

document.getElementById("search").addEventListener("input",renderTable);
document.getElementById("categoryFilter").addEventListener("change",renderTable);

function renderTable(){
  const tbody = document.getElementById("data");
  tbody.innerHTML="";
  const searchVal=document.getElementById("search").value.toLowerCase();
  const catVal=document.getElementById("categoryFilter").value;

  let filtered = inquiries.filter(i=>{
    if(searchVal && !i.product.toLowerCase().includes(searchVal)) return false;
    if(catVal && i.salePurchase!==catVal) return false;
    return true;
  });

  if(sortField){
    filtered.sort((a,b)=>{
      if(a[sortField]<b[sortField]) return sortAsc?-1:1;
      if(a[sortField]>b[sortField]) return sortAsc?1:-1;
      return 0;
    });
  }

  filtered.forEach((i,index)=>{
    tbody.innerHTML+=`
    <tr class="status-${i.status}">
      <td><input type="checkbox" class="rowCheckbox checkbox"></td>
      <td>${i.date}</td>
      <td>${i.product}</td>
      <td>${i.salePurchase}</td>
      <td contenteditable="true" onblur="updateField(${index},'qty',this.innerText)">${i.qty}</td>
      <td contenteditable="true" onblur="updateField(${index},'party',this.innerText)">${i.party}</td>
      <td contenteditable="true" onblur="updateField(${index},'availableWith',this.innerText)">${i.availableWith}</td>
      <td>${i.salesmanId}</td>
      <td class="actionIcons">
        <span onclick="editInquiry(${index})">‚úèÔ∏è</span>
        <span onclick="toggleStatus(${index})">üîÑ</span>
      </td>
    </tr>`;
  });

  // Totals
  const totalsDiv=document.getElementById("totals");
  totalsDiv.innerHTML="";
  let totals={}, pending=0, closed=0;
  inquiries.forEach(i=>{
    totals[i.product]=(totals[i.product]||0)+i.qty;
    if(i.status==="Open") pending+=i.qty;
    if(i.status==="Closed") closed+=i.qty;
  });
  for(let p in totals) totalsDiv.innerHTML+=`<div class="qtyItem">${p}: <b>${totals[p]}</b></div>`;
  document.getElementById("statusTotals").innerHTML=`<b>Pending Qty:</b> ${pending} | <b>Closed Qty:</b> ${closed}`;
}

function updateField(index,field,value){
  if(field==="qty") value=Number(value);
  inquiries[index][field]=value;
}

function editInquiry(index){
  editIndex=index;
  document.getElementById("product").value=inquiries[index].product;
  document.getElementById("salePurchase").value=inquiries[index].salePurchase;
  document.getElementById("qty").value=inquiries[index].qty;
  document.getElementById("party").value=inquiries[index].party;
  document.getElementById("rate").value=inquiries[index].rate;
  document.getElementById("availableWith").value=inquiries[index].availableWith;
  document.getElementById("remark").value=inquiries[index].remark;
}

</script>
</body>
</html>
