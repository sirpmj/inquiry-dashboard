<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inquiry Pool Dashboard</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{margin:0;font-family:'Poppins',sans-serif;background:#f4f6f9}
header{background:linear-gradient(135deg,#1f2937,#111827);color:#fff;padding:16px;display:flex;justify-content:space-between;align-items:center}
header span{cursor:pointer;background:#6366f1;padding:6px 10px;border-radius:6px}
.container{max-width:1200px;margin:auto;padding:12px}
.card{background:#fff;border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 4px 14px rgba(0,0,0,.06)}
input,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin:6px 0}
button{background:#6366f1;color:#fff;border:none;cursor:pointer}
button.danger{background:#ef4444}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:8px;border-bottom:1px solid #eee}
th{background:#111827;color:#fff;position:sticky;top:0}
.status-Open{background:#fff7d6}
.status-Matched{background:#dbfce7}
.status-Closed{background:#ffe1e1}
.followToday{border-left:5px solid red}
.qtyBox{display:flex;gap:10px;flex-wrap:wrap}
.qtyItem{background:#eef2ff;padding:6px 10px;border-radius:6px;font-size:13px}
</style>
</head>

<body>

<header>
  ðŸ“¦ Inquiry Pool Dashboard
  <span onclick="logout()">Logout</span>
</header>

<div class="container">

<!-- LOGIN -->
<div class="card" id="loginBox">
  <h3>Login / Signup</h3>
  <input id="salesmanName" placeholder="Name (Signup only)">
  <select id="role">
    <option value="salesman">Salesman</option>
    <option value="admin">Admin</option>
  </select>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="signup()">Sign Up</button>
  <button onclick="login()">Login</button>
</div>

<div class="card" id="userBox" style="display:none">
  Logged in as: <b id="userName"></b>
</div>

<!-- FILTER -->
<div class="card" id="filterCard" style="display:none">
  <div class="grid">
    <input id="search" placeholder="Search Product">
    <select id="filterType">
      <option value="">All Type</option>
      <option>Sales</option>
      <option>Purchase</option>
    </select>
    <select id="filterStatus">
      <option value="">All Status</option>
      <option>Open</option>
      <option>Matched</option>
      <option>Closed</option>
    </select>
    <button onclick="exportCSV()">Export CSV</button>
  </div>
</div>

<!-- ADD -->
<div class="card" id="inquiryCard" style="display:none">
<h3>Add Inquiry</h3>
<div class="grid">
  <select id="inquiryType">
    <option value="">Inquiry Type</option>
    <option>Sales</option>
    <option>Purchase</option>
  </select>
  <input id="product" placeholder="Product">
  <input id="qty" placeholder="Qty">
  <input id="party" placeholder="Party Name">
  <input id="availableWith" placeholder="Available / Required With">
  <input id="followUp" type="date">
</div>
<button onclick="addInquiry()">Save</button>
</div>

<!-- REPORT -->
<div class="card" id="reportCard" style="display:none">
<h3>Reports</h3>
<div class="qtyBox" id="reportBox"></div>
</div>

<!-- TABLE -->
<div class="card" id="tableCard" style="display:none">
<table>
<thead>
<tr>
<th>Date</th><th>Type</th><th>Product</th><th>Qty</th>
<th>Party</th><th>Follow-up</th><th>Salesman</th><th>Status</th><th>Action</th>
</tr>
</thead>
<tbody id="data"></tbody>
</table>
</div>

</div>

<script>
const firebaseConfig={
 apiKey:"AIzaSyCuPj2Zayn-b-USaCoC3d_eA0FALPrBqXg",
 authDomain:"inquiry-pool-dashboard.firebaseapp.com",
 projectId:"inquiry-pool-dashboard"
};
firebase.initializeApp(firebaseConfig);

const db=firebase.firestore(),auth=firebase.auth();
let currentUserName="",currentUserRole="",currentUID="";

auth.onAuthStateChanged(user=>{
 if(user){
  currentUID=user.uid;
  db.collection("users").doc(user.uid).get().then(d=>{
    currentUserName=d.data().name;
    currentUserRole=d.data().role;
    userName.innerText=currentUserName+" ("+currentUserRole+")";
    ["userBox","filterCard","inquiryCard","reportCard","tableCard"]
      .forEach(id=>document.getElementById(id).style.display="block");
    loginBox.style.display="none";
    loadTable();
  });
 } else {
  loginBox.style.display="block";
 }
});

function signup(){
 if(!salesmanName.value||!email.value||!password.value) return alert("All fields required");
 auth.createUserWithEmailAndPassword(email.value,password.value)
 .then(c=>{
  db.collection("users").doc(c.user.uid).set({
    name:salesmanName.value,
    email:email.value,
    role:role.value
  });
 });
}
function login(){auth.signInWithEmailAndPassword(email.value,password.value);}
function logout(){auth.signOut();}

function addInquiry(){
 if(!inquiryType.value) return alert("Select type");
 db.collection("inquiries").add({
  date:new Date().toLocaleDateString(),
  inquiryType:inquiryType.value,
  product:product.value,
  qty:Number(qty.value),
  party:party.value,
  availableWith:availableWith.value,
  followUp:followUp.value,
  salesman:currentUserName,
  uid:currentUID,
  status:"Open",
  createdAt:firebase.firestore.FieldValue.serverTimestamp()
 });
}

function loadTable(){
 db.collection("inquiries").orderBy("createdAt","desc")
 .onSnapshot(snap=>{
  data.innerHTML=""; reportBox.innerHTML="";
  let rpt={};
  snap.forEach(doc=>{
   const d=doc.data();
   if(search.value && !d.product.toLowerCase().includes(search.value.toLowerCase())) return;
   if(filterType.value && d.inquiryType!==filterType.value) return;
   if(filterStatus.value && d.status!==filterStatus.value) return;

   rpt[d.product]=(rpt[d.product]||0)+d.qty;
   const today=d.followUp===new Date().toISOString().slice(0,10);

   data.innerHTML+=`
   <tr class="status-${d.status} ${today?'followToday':''}">
   <td>${d.date}</td><td>${d.inquiryType}</td><td>${d.product}</td>
   <td>${d.qty}</td><td>${d.party}</td><td>${d.followUp||'-'}</td>
   <td>${d.salesman}</td><td>${d.status}</td>
   <td>${currentUserRole==="admin"||d.uid===currentUID?
   `<button class="danger" onclick="db.collection('inquiries').doc('${doc.id}').delete()">X</button>`:""}</td>
   </tr>`;
  });
  for(let k in rpt) reportBox.innerHTML+=`<div class="qtyItem">${k}: ${rpt[k]}</div>`;
 });
}

function exportCSV(){
 let csv="Date,Type,Product,Qty,Party,FollowUp,Salesman,Status\n";
 document.querySelectorAll("#data tr").forEach(r=>{
  csv+=Array.from(r.children).slice(0,8).map(td=>td.innerText).join(",")+"\n";
 });
 const a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
 a.download="inquiry.csv";a.click();
}
</script>

</body>
</html>
